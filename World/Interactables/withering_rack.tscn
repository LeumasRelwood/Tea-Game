[gd_scene load_steps=10 format=3 uid="uid://28fco0feg03n"]

[ext_resource type="Script" path="res://InventoryManagers/InventoryDataWithering.gd" id="1_obpoq"]
[ext_resource type="Script" path="res://InventoryManagers/InventoryDataWithered.gd" id="2_f8aew"]
[ext_resource type="Script" path="res://Hit and Hurtboxes/hurtbox.gd" id="2_semco"]
[ext_resource type="Texture2D" uid="uid://2tvapvqdxy0n" path="res://World/Interactables/witheringrack.jpg" id="2_v17pa"]

[sub_resource type="GDScript" id="GDScript_kvbl4"]
script/source = "extends StaticBody2D

signal toggle_external_withering(external_inventory_owner)
signal update_withering_menu(inventory_data_input, inventory_data_output, type, craft_quantity)
signal update_progress_bar(progress)
signal set_external_inventory_owner()
signal check_for_new_owner()

@export var inventory_data_input: InventoryDataWithering
@export var inventory_data_output: InventoryDataWithered
@onready var global = get_node(\"/root/Global\")
@onready var hurtbox = $Hurtbox
@onready var timer = $Timer
@onready var progress_clicker_timer = $Timer/ProgressClickerTimer
@onready var in_progress: bool = false
@onready var craft_quantity: int
@export var type = \"Bamboo Withering Rack\"
@export var process_time = 5
@export var progress_clicker_time = .1
@export var capacity = 5
@export var progress = 0
@export var selected_recipe: SlotData = null

func _ready():
	timer.wait_time = process_time
	progress_clicker_timer.wait_time = progress_clicker_time

func _on_hurtbox_player_interact(user):
		set_external_inventory_owner.emit(self)
		toggle_external_withering.emit(self)
		update_withering_menu.emit(inventory_data_input, inventory_data_output, type, capacity)
		update_progress_bar.emit(progress)
		is_start_button_disabled()

func reupdate_withering_menu():
	update_withering_menu.emit(inventory_data_input, inventory_data_output, type, capacity)

func _on_timer_timeout():
	if inventory_data_output.set_item_output(selected_recipe, craft_quantity, 0):
		progress_clicker_timer.stop()
		progress = 0
		update_progress_bar.emit(progress)
		check_for_new_owner.emit()
		in_progress = false
		is_start_button_disabled()

func _on_progress_clicker_timer_timeout():
	progress += progress_clicker_time / process_time * 100
	in_progress = true
	update_progress_bar.emit(progress)

func is_start_button_disabled():
	if selected_recipe and in_progress == false:
		for slot_data in inventory_data_input.slot_datas:
			if not slot_data:
				return true
			else:
				if not inventory_data_output.slot_datas[0]:
					return false
				else:
					return true
	else:
		return true

func craft_with_slot_data(index):
	craft_quantity = clamp(inventory_data_input.slot_datas[index].quantity, 1, capacity)
	inventory_data_input.craft_with_slot_data(craft_quantity, index)



var MouseSelected = false
var mouse_offset = Vector2.ZERO

func _process(delta):
	if MouseSelected:
		followMouse()

func followMouse():
	if get_node(\"/root/World\").mouse_in_build_area:
		var mouse_tile = get_node(\"/root/World\").buildable_tile_map.local_to_map(get_global_mouse_position())
		var local_pos = get_node(\"/root/World\").buildable_tile_map.map_to_local(mouse_tile)
		global_position = get_node(\"/root/World\").buildable_tile_map.to_global(local_pos)
	else:
		global_position = get_global_mouse_position() + Vector2(1, 1)

func _on_drag_box_input_event(viewport, event, shape_idx):
	if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_LEFT:
		if event.pressed:
			mouse_offset = position - get_global_mouse_position()
			MouseSelected = true
		elif get_node(\"/root/World\").mouse_in_build_area:
			MouseSelected = false
"

[sub_resource type="Resource" id="Resource_4omxb"]
script = ExtResource("1_obpoq")
slot_datas = Array[Resource("res://InventoryManagers/SlotData.gd")]([null])

[sub_resource type="Resource" id="Resource_vrnf0"]
script = ExtResource("2_f8aew")
slot_datas = Array[Resource("res://InventoryManagers/SlotData.gd")]([null])

[sub_resource type="RectangleShape2D" id="RectangleShape2D_0vjeg"]
size = Vector2(45.5, 19)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_jpjlc"]
size = Vector2(43.3145, 30.1318)

[node name="WitheringRack" type="StaticBody2D" groups=["external_withering"]]
collision_mask = 2
script = SubResource("GDScript_kvbl4")
inventory_data_input = SubResource("Resource_4omxb")
inventory_data_output = SubResource("Resource_vrnf0")

[node name="Timer" type="Timer" parent="."]
wait_time = 5.0
one_shot = true

[node name="ProgressClickerTimer" type="Timer" parent="Timer"]
wait_time = 0.5

[node name="Sprite2D" type="Sprite2D" parent="."]
scale = Vector2(0.074, 0.074)
texture = ExtResource("2_v17pa")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(-0.25, 6.5)
shape = SubResource("RectangleShape2D_0vjeg")

[node name="Hurtbox" type="Area2D" parent="."]
collision_layer = 32
collision_mask = 64
script = ExtResource("2_semco")

[node name="Timer" type="Timer" parent="Hurtbox"]

[node name="CollisionShape2D2" type="CollisionShape2D" parent="Hurtbox"]
position = Vector2(7.15256e-07, -1.19209e-07)
scale = Vector2(1.062, 1.062)
shape = SubResource("RectangleShape2D_jpjlc")

[node name="DragBox" type="Area2D" parent="."]
position = Vector2(0, 1.5)

[node name="CollisionShape2D2" type="CollisionShape2D" parent="DragBox"]
position = Vector2(7.15256e-07, -1.5)
scale = Vector2(1.062, 1.062)
shape = SubResource("RectangleShape2D_jpjlc")

[connection signal="timeout" from="Timer" to="." method="_on_timer_timeout"]
[connection signal="timeout" from="Timer/ProgressClickerTimer" to="." method="_on_progress_clicker_timer_timeout"]
[connection signal="invincibility_ended" from="Hurtbox" to="Hurtbox" method="_on_invincibility_ended" flags=18]
[connection signal="invincibility_started" from="Hurtbox" to="Hurtbox" method="_on_invincibility_started" flags=18]
[connection signal="player_interact" from="Hurtbox" to="." method="_on_hurtbox_player_interact"]
[connection signal="timeout" from="Hurtbox/Timer" to="Hurtbox" method="_on_timer_timeout" flags=18]
[connection signal="input_event" from="DragBox" to="." method="_on_drag_box_input_event"]
